<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>一步步教你实现一个todomvc(基于Regularjs) | 拴萝卜的棍子</title>
  <meta name="author" content="leeluolee">
  
  <meta name="description" content="所有涉及javascript的一切(nodejs, frontend-develop, compile-to-js...etc) 和各种Web相关">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="一步步教你实现一个todomvc(基于Regularjs)"/>
  <meta property="og:site_name" content="拴萝卜的棍子"/>

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="拴萝卜的棍子" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  <script src="/js/jquery.js"></script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-41582683-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">拴萝卜的棍子</a></h1>
  <h2><a href="/">萝卜的技术博客</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/atom.xml">订阅</a></li>
    
      <li><a href="https://github.com/leeluolee">Github</a></li>
    
      <li><a href="/resume">关于我(简历)</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-08-25T01:29:24.000Z"><a href="/2014/08/25/create-a-todomvc-step-by-step/">8月 25 2014</a></time>
      
      
  
    <h1 class="title">一步步教你实现一个todomvc(基于Regularjs)</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="前言">前言</h2>
<p>现在市面上充斥了越来越多的javascript框架，给开发者的技术选型带来极大的选择成本，<a href="http://todomvc.com/" target="_blank" rel="external">todomvc</a>在这个环境下应运而生. </p>
<p>由于todomvc有一个完整的实现定义，它复杂度适中，大概就是平时开发的一个组件的功能复杂度，开发者可以轻松对各个框架的代码做对比，同时由于功能一致，也可以进行各框架之间的<a href="http://regularjs.github.io/perf/todomvc-benchmark/index.html" target="_blank" rel="external">性能对比(当然这个测试案例其实并没有很大的实际意义)</a>. </p>
<p><img src="http://todomvc.com/site-assets/screenshot.png" alt="todomvc"></p>
<a id="more"></a>
<p>接下来这篇指南会一步步的带大家使用<a href="http://regularjs.github.io/" target="_blank" rel="external">Regularjs</a>实现一个完整的todomvc的app(主要是逻辑部分)</p>
<p><a href="http://regularjs.github.io/" target="_blank" rel="external">Regularjs</a>是类似react定位的组件库，它其实是一个结合了基于字符串的parser和基于Dom的compiler的动态模板引擎，它compile之后的内容会与dom产生关联(而不是死的字符串)，帮助你实现动态的模板效果，你可以利用以往使用字符串模板的经验来快速实现一个富功能的组件。</p>
<blockquote>
<p>你也可以先参考官方指南的Getting-Start章节(<a href="http://regularjs.github.io/guide/zh/getting-start/README.html" target="_blank" rel="external">中文</a>, <a href="http://regularjs.github.io/guide/en/getting-start/README.html" target="_blank" rel="external">英文</a>)</p>
</blockquote>
<h2 id="第一步:_静态页面">第一步: 静态页面</h2>
<p>第一步，我们需要一个完整的静态页面作为后续逻辑的基础，这里我们不再详细介绍如何实现这个页面，直接从todomvc的官网copy一份静态页面下来.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--引入todomvc.css--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">href</span>=<span class="value">"http://todomvc.com/architecture-examples/angularjs/bower_components/todomvc-common/base.css"</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"todoapp"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">h1</span>&gt;</span>TODOmvc<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"new-todo"</span> <span class="attribute">placeholder</span>=<span class="value">"What needs to be done?"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">section</span> <span class="attribute">id</span>=<span class="value">"main"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"toggle-all"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"toggle-all"</span>&gt;</span>Mark all as complete<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"todo-list"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span> <span class="attribute">class</span>=<span class="value">"completed"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"view"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">input</span> <span class="attribute">class</span>=<span class="value">"toggle"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> <span class="attribute">checked</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">label</span>&gt;</span>sleep<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">button</span> <span class="attribute">class</span>=<span class="value">"destroy"</span>&gt;</span><span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"edit"</span> <span class="attribute">class</span>=<span class="value">"edit"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span> <span class="attribute">class</span>=<span class="value">""</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"view"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">input</span> <span class="attribute">class</span>=<span class="value">"toggle"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">label</span>&gt;</span>work<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">button</span> <span class="attribute">class</span>=<span class="value">"destroy"</span>&gt;</span><span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"edit"</span> <span class="attribute">class</span>=<span class="value">"edit"</span>&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">section</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">footer</span> <span class="attribute">id</span>=<span class="value">"footer"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">id</span>=<span class="value">"todo-count"</span>&gt;</span> <span class="tag">&lt;<span class="title">strong</span>&gt;</span>1<span class="tag">&lt;/<span class="title">strong</span>&gt;</span></div><div class="line">      item left</div><div class="line">    <span class="tag">&lt;/<span class="title">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"filters"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span> <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"selected"</span>&gt;</span>All<span class="tag">&lt;/<span class="title">a</span>&gt;</span> <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span> <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">""</span>&gt;</span>Active<span class="tag">&lt;/<span class="title">a</span>&gt;</span> <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span> <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">""</span>&gt;</span>Completed<span class="tag">&lt;/<span class="title">a</span>&gt;</span> <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"clear-completed"</span>&gt;</span>Clear completed (1)<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">footer</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">footer</span> <span class="attribute">id</span>=<span class="value">"info"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">p</span>&gt;</span>Double-click to edit a todo<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">p</span>&gt;</span>Created by @leeluolee<span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">p</span>&gt;</span></div><div class="line">    Part of</div><div class="line">    <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"http://todomvc.com"</span>&gt;</span>TodoMVC<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">footer</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 引入regularjs --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"https://rawgit.com/regularjs/regular/master/dist/regular.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>你可以直接保存成index.html来查看效果,也直接在<a href="http://codepen.io/leeluolee/pen/EuHcd" target="_blank" rel="external">codepen中查看</a></p>
<h2 id="第二步:_视图(模板)与数据model分离">第二步: 视图(模板)与数据model分离</h2>
<p>按以往的经验，我们应该使用jQuery等框架来一个个绑定节点处理业务逻辑了.这样会带来很多的问题，一旦你去绑定了大量的dom事件和进行了过多的dom操作，往往会带你进入难以维护的深渊，我们可以使用模板来强制将model(模型)与视图(view)分开。</p>
<p>所以这一步，我们什么都不做，仅仅只是将上面的静态页面转由regularjs模板生成.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"todoapp"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">'template/regular'</span> <span class="attribute">id</span>=<span class="value">'todomvc'</span>&gt;</span><span class="javascript"></span></div><div class="line">  &lt;div&gt;</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>TODOMVC<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"new-todo"</span> <span class="attribute">placeholder</span>=<span class="value">"What needs to be done?"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">section</span> <span class="attribute">id</span>=<span class="value">"main"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"toggle-all"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"toggle-all"</span>&gt;</span>Mark all as complete<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"todo-list"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span> <span class="attribute">class</span>=<span class="value">"completed"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"view"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">input</span> <span class="attribute">class</span>=<span class="value">"toggle"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> <span class="attribute">checked</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">label</span>&gt;</span>sleep<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">button</span> <span class="attribute">class</span>=<span class="value">"destroy"</span>&gt;</span><span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"edit"</span> <span class="attribute">class</span>=<span class="value">"edit"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span> <span class="attribute">class</span>=<span class="value">""</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"view"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">input</span> <span class="attribute">class</span>=<span class="value">"toggle"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">label</span>&gt;</span>work<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">button</span> <span class="attribute">class</span>=<span class="value">"destroy"</span>&gt;</span><span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"edit"</span> <span class="attribute">class</span>=<span class="value">"edit"</span>&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">section</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">footer</span> <span class="attribute">id</span>=<span class="value">"footer"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">id</span>=<span class="value">"todo-count"</span>&gt;</span> <span class="tag">&lt;<span class="title">strong</span>&gt;</span>1<span class="tag">&lt;/<span class="title">strong</span>&gt;</span></div><div class="line">      item left</div><div class="line">    <span class="tag">&lt;/<span class="title">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"filters"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span> <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"selected"</span>&gt;</span>All<span class="tag">&lt;/<span class="title">a</span>&gt;</span> <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span> <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">""</span>&gt;</span>Active<span class="tag">&lt;/<span class="title">a</span>&gt;</span> <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">li</span>&gt;</span> <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">""</span>&gt;</span>Completed<span class="tag">&lt;/<span class="title">a</span>&gt;</span> <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"clear-completed"</span>&gt;</span>Clear completed (1)<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">footer</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>然后我们利用regularjs来compile这个模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> TodoMVC = Regular.extend({</div><div class="line">    template: <span class="string">"#todomvc"</span></div><div class="line">})</div><div class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> TodoMVC({data: {}}).$inject(<span class="string">'#todoapp'</span>);</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>在codepen中查看结果</p>
<p>其中<code>Regular.extend</code>用于定义一个组件，最基本的情况就是指定一个模板(template字段)，而<code>new TodoMVC</code>相当于是compile这个组件，一般我们会在这里传入<code>data</code>模型，我们同时将compile后的组件插入到节点<code>#todoapp</code>中.</p>
<p>事实上大家都发现了，这里我们完全没有做额外的逻辑，但是这是将view与model分开的关键一步.</p>
<p><a href="http://codepen.io/leeluolee/pen/xvCjm" target="_blank" rel="external">DEMO2</a></p>
<h2 id="第三步:_使用#list指令来处理列表">第三步: 使用#list指令来处理列表</h2>
<p>我们发现，很明显的model可以抽象成一份todos的数组，所以我们的第一步是使用list来处理列表逻辑(这里我们省略了其余部分的模板，只列出了li部分的逻辑)</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">'template/regular'</span> <span class="attribute">id</span>=<span class="value">'todomvc'</span>&gt;</span><span class="javascript"></span></div><div class="line">....</div><div class="line">{{#list todos as todo}}</div><div class="line">&lt;li  r-<span class="keyword">class</span>=<span class="string">"{'completed': todo.completed, 'editing': todo.editing}"</span>&gt;</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"view"</span>&gt;</span></span></div><div class="line">      <span class="tag">&lt;<span class="title">input</span> <span class="attribute">class</span>=<span class="value">"toggle"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> <span class="attribute">r-model</span>=<span class="value">{{</span> <span class="attribute">todo.completed</span> }}&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">label</span> <span class="attribute">on-dblclick</span>=<span class="value">{{todo.editing</span> = <span class="attribute">true</span>}}&gt;</span>{{ todo.description }}<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">button</span> <span class="attribute">on-click</span>=<span class="value">{{</span> <span class="attribute">todos.splice</span>(<span class="attribute">todo_index</span>,<span class="attribute">1</span>) }} <span class="attribute">class</span>=<span class="value">"destroy"</span>&gt;</span><span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"edit"</span> <span class="attribute">class</span>=<span class="value">"edit"</span> <span class="attribute">on-enter</span>=<span class="value">{{</span> <span class="attribute">todo.editing</span> = <span class="attribute">false</span> }} <span class="attribute">r-model</span>=<span class="value">{{todo.description}}</span> <span class="attribute">autofocus</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">{{/list}}</div><div class="line"></div><div class="line">.....</div><div class="line"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript"></span></div></pre></td></tr></table></figure>

<p>list规则用于处理循环逻辑，完整描述可以查看<a href="http://regularjs.github.io/guide/zh/syntax/list.html" target="_blank" rel="external">Regularjs指南的list部分</a>。 这里我们也应用到了最基础的<a href="http://regularjs.github.io/guide/zh/syntax/inteplation.html" target="_blank" rel="external">插值</a>(<code>{{}}</code>)</p>
<p>我们传入一个todos的假数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> todos = [</div><div class="line">    {completed: <span class="literal">true</span>, description: <span class="string">"sleep"</span> },</div><div class="line">    {completed: <span class="literal">false</span>, description: <span class="string">"work"</span> }</div><div class="line">]</div><div class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> TodoMVC({</div><div class="line">    data: {todos: todos}</div><div class="line">}).$inject(<span class="string">"#todoapp"</span>)</div></pre></td></tr></table></figure>

<p><a href="http://codepen.io/leeluolee/pen/krzjc" target="_blank" rel="external">DEMO3</a></p>
<p>可以看到我们同时利用directive处理了一些业务逻辑</p>
<ol>
<li><code>r-class</code>： 属于对象表达式，每当值为真，添加对应的键作为class</li>
<li><code>r-model</code>: 使表单项与某字段形成双向绑定</li>
<li><code>on-xx</code>: 绑定事件</li>
</ol>
<p>regularjs的parse是基于字符串的，它输出包含完整信息的ast给基于dom的compiler使用，这样其实输出的内容是不会包含一些常规dom-based模板的placeholder信息的(比如angular的<code>ng-xx</code>).</p>
<p>到这一步，其实可以发现，我们可以处理一部分业务逻辑了，比如</p>
<ol>
<li>双击编辑</li>
<li>回车完成编辑</li>
<li>标记完成</li>
<li>删除指定的todo项(利用todo_index下标，它的命名取决于你定义的列表项的名称加<code>_index</code>)</li>
</ol>
<p>regularjs的数据驱动是基于代码脏检查的(与angular一致)，所以你可以直接操作裸数据来完成状态变更.</p>
<h2 id="第四步：_完善我们的组件业务逻辑">第四步： 完善我们的组件业务逻辑</h2>
<p>目前，除了中间列表部分的view，其它部分的数据都没有完成数据联动. 我们遗留的业务逻辑有:</p>
<ol>
<li>点击下方的<code>All Active Completed</code>面板要完成todos面板的切换来分别显示所有、未完成、完成的todo列表</li>
<li>上面的input可以进行新建todo</li>
<li>切换左上角的checkbox可以进行标记全部和取消编辑全部的操作</li>
<li>点击右下角的clearComplete 应该可以删除所有完成的列表项</li>
</ol>
<p>一个组件的业务逻辑(对于一个mvvm模式的组件来讲，业务逻辑应该是纯数据操作)应该是在定义时就进行确定. 我们在extend时定义这些业务.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> TodoMVC = Regular.extend({</div><div class="line">    template: <span class="string">'#todomvc'</span>,</div><div class="line">    <span class="comment">// get the list;</span></div><div class="line">    getList: <span class="function"><span class="keyword">function</span><span class="params">(filter)</span></span>{</div><div class="line">      <span class="keyword">if</span>(!filter || filter === <span class="string">'all'</span>) <span class="keyword">return</span> <span class="keyword">this</span>.data.todos;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">this</span>.data.todos.filter(<span class="function"><span class="keyword">function</span><span class="params">(item)</span></span>{</div><div class="line">        <span class="keyword">return</span> filter === <span class="string">'completed'</span>? item.completed : !item.completed;</div><div class="line">      });</div><div class="line">    },</div><div class="line">    <span class="comment">// toggle all todo's completed state</span></div><div class="line">    toggleAll: <span class="function"><span class="keyword">function</span><span class="params">(sign)</span></span>{</div><div class="line">      <span class="keyword">this</span>.data.todos.forEach(<span class="function"><span class="keyword">function</span><span class="params">(item)</span></span>{</div><div class="line">        <span class="keyword">return</span> item.completed = !sign;</div><div class="line">      });</div><div class="line">    },</div><div class="line">    <span class="comment">// clear all compleled</span></div><div class="line">    clearCompleted: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">      <span class="keyword">this</span>.data.todos = <span class="keyword">this</span>.data.todos.filter(<span class="function"><span class="keyword">function</span><span class="params">(item)</span></span>{</div><div class="line">        <span class="keyword">return</span> !item.completed</div><div class="line">      });</div><div class="line">    },</div><div class="line">    <span class="comment">// create a new todo</span></div><div class="line">    newTodo: <span class="function"><span class="keyword">function</span><span class="params">(editTodo)</span></span>{</div><div class="line">      <span class="keyword">var</span> data = <span class="keyword">this</span>.data;</div><div class="line">      data.todos.unshift({description: editTodo});</div><div class="line">      data.editTodo = <span class="string">""</span>;</div><div class="line">    }</div><div class="line">})</div></pre></td></tr></table></figure>

<p>至此，TodoMVC实现了以下4个对应逻辑</p>
<ol>
<li>getList(sign): 用于获得不同的列表</li>
<li>newTodo(editTodo): 用于创建新的todo</li>
<li>toggleAll(sign): 用于全部标注完成，和全部取消</li>
<li>clearCompleted(): 用于删除所有完成的todo</li>
</ol>
<p>大家可以发现，所有的操作都是基于裸数据的业务逻辑，没有添加任何dom操作。</p>
<p>但是如何使用这些函数定义呢？</p>
<p>很简单，首先extend的函数是定义在组件原型上的，其次模板中的this是指向组件实例，即：</p>
<p>我们可以通过this.xx()等方式在模板中调用这些逻辑定义。完整模板我们修改为</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">h1</span>&gt;</span>regular-todo<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"new-todo"</span> </span></div><div class="line">    <span class="attribute">on-enter</span>=<span class="value">{{</span> <span class="attribute">this.newTodo</span>(<span class="attribute">editTodo</span>) }} </div><div class="line">    <span class="attribute">placeholder</span>=<span class="value">"What needs to be done?"</span> </div><div class="line">    <span class="attribute">r-model</span>=<span class="value">{{</span> <span class="attribute">editTodo</span> }}&gt;</div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">section</span> <span class="attribute">id</span>=<span class="value">"main"</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"toggle-all"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> </span></div><div class="line">    <span class="attribute">on-change</span>=<span class="value">{{this.toggleAll(items.length</span> =<span class="value">==</span> <span class="attribute">this.getList</span>('<span class="attribute">completed</span>')<span class="attribute">.length</span>)}} </div><div class="line">    <span class="attribute">checked</span>=<span class="value">{{items.length</span> =<span class="value">==</span> <span class="attribute">this.getList</span>('<span class="attribute">completed</span>')<span class="attribute">.length</span> }}&gt;</div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"toggle-all"</span>&gt;</span>Mark all as complete<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"todo-list"</span>&gt;</span></div><div class="line">    {{#list this.getList(filter) as todo}}</div><div class="line">    <span class="tag">&lt;<span class="title">li</span>  <span class="attribute">r-class</span>=<span class="value">"{'completed': todo.completed, 'editing': todo.editing}"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"view"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">class</span>=<span class="value">"toggle"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> <span class="attribute">r-model</span>=<span class="value">{{</span> <span class="attribute">todo.completed</span> }}&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">label</span> <span class="attribute">on-dblclick</span>=<span class="value">{{todo.editing</span> = <span class="attribute">true</span>}}&gt;</span></div><div class="line">            {{ todo.description }}</div><div class="line">        <span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">button</span> </span></div><div class="line">            <span class="attribute">on-click</span>=<span class="value">{{</span> <span class="attribute">todos.splice</span>(<span class="attribute">todo_index</span>,<span class="attribute">1</span>) }} <span class="attribute">class</span>=<span class="value">"destroy"</span>&gt;<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"edit"</span> <span class="attribute">class</span>=<span class="value">"edit"</span> </span></div><div class="line">        <span class="attribute">on-enter</span>=<span class="value">{{</span> <span class="attribute">todo.editing</span> = <span class="attribute">false</span> }} </div><div class="line">        <span class="attribute">r-model</span>=<span class="value">{{todo.description}}</span> <span class="attribute">autofocus</span>&gt;</div><div class="line">    <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    {{/list}}</div><div class="line">  <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">section</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">footer</span> <span class="attribute">id</span>=<span class="value">"footer"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">id</span>=<span class="value">"todo-count"</span>&gt;</span> <span class="tag">&lt;<span class="title">strong</span>&gt;</span>{{ this.getList('active').length }}<span class="tag">&lt;/<span class="title">strong</span>&gt;</span></div><div class="line">    {{ this.getList('active').length === 1 ? 'item' : 'items' }} left</div><div class="line">  <span class="tag">&lt;/<span class="title">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"filters"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"{{ filter === 'all'? 'selected' : '' }}"</span>  <span class="attribute">href</span>=<span class="value">"javascript:;"</span> <span class="attribute">on-click</span>=<span class="value">{{filter='all'}}</span>&gt;</span>All<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"{{ filter === 'active'? 'selected' : '' }}"</span> <span class="attribute">href</span>=<span class="value">'javascript:;'</span> <span class="attribute">on-click</span>=<span class="value">{{filter</span> = '<span class="attribute">active</span>'}}&gt;</span>Active<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"{{ filter === 'completed'? 'selected' : '' }}"</span> <span class="attribute">href</span>=<span class="value">"javascript:;"</span> <span class="attribute">on-click</span>=<span class="value">{{filter</span> = '<span class="attribute">completed</span>'}}&gt;</span>Completed<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"clear-completed"</span> <span class="attribute">on-click</span>=<span class="value">{{this.clearCompleted()}}</span>&gt;</span>Clear completed ({{ this.getList('completed').length }})<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">footer</span>&gt;</span></div></pre></td></tr></table></figure>

<p><a href="http://codepen.io/leeluolee/pen/mcHxw" target="_blank" rel="external">DEMO3</a></p>
<h2 id="第五步：_使用计算属性来简化我们的表达式">第五步： 使用计算属性来简化我们的表达式</h2>
<p>这里我们发现，使用了大量的相似的表达式在我们的模板里，比如为了处理全选与反选，我们引入有如此肮脏的模板代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"toggle-all"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> </span></div><div class="line">   <span class="attribute">on-change</span>=<span class="value">{{this.toggleAll(items.length</span> =<span class="value">==</span> <span class="attribute">this.getList</span>('<span class="attribute">completed</span>')<span class="attribute">.length</span>)}} </div><div class="line">   <span class="attribute">checked</span>=<span class="value">{{items.length</span> =<span class="value">==</span> <span class="attribute">this.getList</span>('<span class="attribute">completed</span>')<span class="attribute">.length</span> }}&gt;</div></pre></td></tr></table></figure>

<p>如果我们引入计算属性(computed-property)就可以简化此表达式</p>
<p>我们可以extend时进行计算属性的定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TodoMVC = Regular.extend({</div><div class="line">    template: <span class="string">"#todomvc"</span>,</div><div class="line">    computed: {</div><div class="line">      completedLength: <span class="string">"this.getList('completed').length"</span>,</div><div class="line">      activeLength: <span class="string">"this.getList('active').length"</span>,</div><div class="line">      allCompleted: {</div><div class="line">        get: <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{</div><div class="line">          <span class="keyword">return</span> data.todos.length === <span class="keyword">this</span>.getList(<span class="string">'completed'</span>).length</div><div class="line">        },</div><div class="line">        set: <span class="function"><span class="keyword">function</span><span class="params">(sign,data)</span></span>{</div><div class="line">          data.todos.forEach(<span class="function"><span class="keyword">function</span><span class="params">(item)</span></span>{</div><div class="line">            item.completed = sign;</div><div class="line">          })</div><div class="line">        }</div><div class="line">      }</div><div class="line">    }</div><div class="line">    <span class="comment">//....other methods...</span></div><div class="line">})</div></pre></td></tr></table></figure>

<p>在这里我们定义三个计算属性</p>
<ol>
<li>completedLength: 代表完成的todo的length</li>
<li>activeLength： 代表未完成的Length，这里可以看到1和2属性，我们都直接传入了一个字符串表达式，因为这里只需要处理读操作，即只是表达式的一种简写替代</li>
<li>allCompleted: 标记是否全部完成，为真则将左上的checkbox打钩。需要注意的是这里还设置了setter函数，用于处理allCompelted的写操作，这里我们做的是，将所有todo标记完成或未完成</li>
</ol>
<p>修改后的模板如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">h1</span>&gt;</span>regular-todo<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"new-todo"</span> <span class="attribute">on-enter</span>=<span class="value">{{</span> <span class="attribute">this.newTodo</span>(<span class="attribute">editTodo</span>) }} <span class="attribute">placeholder</span>=<span class="value">"What needs to be done?"</span> <span class="attribute">r-model</span>=<span class="value">{{</span> <span class="attribute">editTodo</span> }}&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">section</span> <span class="attribute">id</span>=<span class="value">"main"</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"toggle-all"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> <span class="attribute">name</span>=<span class="value">'toggle'</span> <span class="attribute">r-model</span>=<span class="value">'allCompleted'</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"toggle-all"</span>&gt;</span>Mark all as complete<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"todo-list"</span>&gt;</span></div><div class="line">    {{#list this.getList(filter) as todo}}</div><div class="line">    <span class="tag">&lt;<span class="title">li</span>  <span class="attribute">r-class</span>=<span class="value">"{'completed': todo.completed, 'editing': todo.editing}"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"view"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">class</span>=<span class="value">"toggle"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> <span class="attribute">r-model</span>=<span class="value">{{</span> <span class="attribute">todo.completed</span> }}&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">label</span> <span class="attribute">on-dblclick</span>=<span class="value">{{todo.editing</span> = <span class="attribute">true</span>}}&gt;</span>{{ todo.description }}<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">button</span> <span class="attribute">on-click</span>=<span class="value">{{</span> <span class="attribute">todos.splice</span>(<span class="attribute">todo_index</span>,<span class="attribute">1</span>) }} <span class="attribute">class</span>=<span class="value">"destroy"</span>&gt;</span><span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"edit"</span> <span class="attribute">class</span>=<span class="value">"edit"</span><span class="value">on-enter={{</span> <span class="attribute">todo.editing</span> = <span class="attribute">false</span> }} <span class="attribute">r-model</span>=<span class="value">{{todo.description}}</span> <span class="attribute">autofocus</span>&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    {{/list}}</div><div class="line">  <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">section</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">footer</span> <span class="attribute">id</span>=<span class="value">"footer"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">id</span>=<span class="value">"todo-count"</span>&gt;</span> <span class="tag">&lt;<span class="title">strong</span>&gt;</span>{{ activeLength }}<span class="tag">&lt;/<span class="title">strong</span>&gt;</span></div><div class="line">    {{ activeLength === 1 ? 'item' : 'items' }} left</div><div class="line">  <span class="tag">&lt;/<span class="title">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">ul</span> <span class="attribute">id</span>=<span class="value">"filters"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"{{ filter === 'all'? 'selected' : '' }}"</span>  <span class="attribute">href</span>=<span class="value">"javascript:;"</span> <span class="attribute">on-click</span>=<span class="value">{{filter='all'}}</span>&gt;</span>All<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"{{ filter === 'active'? 'selected' : '' }}"</span> <span class="attribute">href</span>=<span class="value">'javascript:;'</span> <span class="attribute">on-click</span>=<span class="value">{{filter</span> = '<span class="attribute">active</span>'}}&gt;</span>Active<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"{{ filter === 'completed'? 'selected' : '' }}"</span> <span class="attribute">href</span>=<span class="value">"javascript:;"</span> <span class="attribute">on-click</span>=<span class="value">{{filter</span> = '<span class="attribute">completed</span>'}}&gt;</span>Completed<span class="tag">&lt;/<span class="title">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"clear-completed"</span> <span class="attribute">on-click</span>=<span class="value">{{this.clearCompleted()}}</span> &gt;</span>Clear completed ({{ completedLength }})<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="title">footer</span>&gt;</span></div></pre></td></tr></table></figure>

<p>至此，我们利用大约40行模板+50行代码实现了todomvc. 并且完全没有掺入dom操作，完全是按照以前使用模板的思维。</p>
<h2 id="第六步:_使用if/else来控制区域的创建与回收">第六步: 使用if/else来控制区域的创建与回收</h2>
<p>按照todomvc的规范定义，我们遗漏了以下两个逻辑</p>
<ol>
<li>需要在没有todos的情况隐藏显示部分，</li>
<li>并且在没有可清楚todo的情况下，隐藏</li>
</ol>
<p>我们可以利用两种方式来实现</p>
<ol>
<li><a href="http://regularjs.github.io/guide/zh/syntax/if.html" target="_blank" rel="external">{{#if}}</a>: 这种情况会将区域完全回收，并移除所有绑定，这是一种语法元素。</li>
<li><a href="http://regularjs.github.io/guide/zh/core/directive.html#4-r-hide-" target="_blank" rel="external">r-hide</a>: 你也可以使用指令来切换节点的可见性，这只是一种指令增强。</li>
</ol>
<p>1相较于2，最大的不同是完整回收，并且可以作用于任意的块: 比如多个并列节点。而2只能以节点为单位(即类似与angular的ng-show)</p>
<p>这里我们采用if来完成我们的需求.修改后的模板如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">{{#if !!todos.length}}</div><div class="line"><span class="tag">&lt;<span class="title">section</span> <span class="attribute">id</span>=<span class="value">"main"</span>&gt;</span></div><div class="line">...ignored for short...</div><div class="line"><span class="tag">&lt;/<span class="title">section</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">footer</span> <span class="attribute">id</span>=<span class="value">"footer"</span>&gt;</span></div><div class="line">  ...ignored for short...</div><div class="line">  {{#if completedLength}}</div><div class="line">  <span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"clear-completed"</span> <span class="attribute">on-click</span>=<span class="value">{{this.clearCompleted()}}</span> &gt;</span>Clear completed ({{ completedLength }})<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">  {{/if}}</div><div class="line"><span class="tag">&lt;/<span class="title">footer</span>&gt;</span></div><div class="line">{{/if}}</div></pre></td></tr></table></figure>

<p><a href="http://codepen.io/leeluolee/pen/mcHxw" target="_blank" rel="external">DEMO5</a></p>
<h2 id="第七步:_抽离子组件">第七步: 抽离子组件</h2>
<p>到目前为止，除了路由部分，我们已经完整实现了整个组件(由于regularjs定义为一个类库，所以不提供框架级的路由服务，大家可以通过类似directorjs等第三方库来实现路由).</p>
<p>但是所有的view都写在了一个模板中，这个不利用后续的重构。我们可以通过子组件来提取一些独立的逻辑，在这个例子里，一个todo项目显然可以独立出来成为一个组件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">li</span>  <span class="attribute">r-class</span>=<span class="value">"{'completed': todo.completed, 'editing': todo.editing}"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"view"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">class</span>=<span class="value">"toggle"</span> <span class="attribute">type</span>=<span class="value">"checkbox"</span> <span class="attribute">r-model</span>=<span class="value">{{</span> <span class="attribute">todo.completed</span> }}&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="title">label</span> <span class="attribute">on-dblclick</span>=<span class="value">{{todo.editing</span> = <span class="attribute">true</span>}}&gt;</span>{{ todo.description }}<span class="tag">&lt;/<span class="title">label</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">button</span> <span class="attribute">on-click</span>=<span class="value">"remove"</span> <span class="attribute">class</span>=<span class="value">"destroy"</span>&gt;</span><span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"edit"</span> <span class="attribute">class</span>=<span class="value">"edit"</span><span class="value">on-enter={{</span> <span class="attribute">todo.editing</span> = <span class="attribute">false</span> }} <span class="attribute">r-model</span>=<span class="value">{{todo.description}}</span> <span class="attribute">autofocus</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">li</span>&gt;</span></div></pre></td></tr></table></figure>

<p>注意这里的<code>on-click=&#39;remove&#39;</code> 代表点击后抛出自定义事件<code>remove</code>, 你可以捕获这个事件来处理删除操作(因为我们无法获得todos数据了)</p>
<p>对应的组件定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Todo = Regular.extend({</div><div class="line">  data: {todo: {}},</div><div class="line">  name: <span class="string">"todo"</span>,</div><div class="line">  template: <span class="string">"#todo"</span></div><div class="line">});</div></pre></td></tr></table></figure>

<p>注意<code>name</code>参数代表，这个组件可以通过<code>&lt;todo &gt;&lt;/todo&gt;</code>的方式插入其它模板中。</p>
<p>重构之前的list部分</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">{{#list this.getList(filter) as todo}}</div><div class="line">    <span class="tag">&lt;<span class="title">todo</span> <span class="attribute">todo</span>=<span class="value">{{todo}}</span> <span class="attribute">on-remove</span>=<span class="value">{{todos.splice(todo_index,1)}}</span> &gt;</span><span class="tag">&lt;/<span class="title">todo</span>&gt;</span></div><div class="line">{{/list}}</div></pre></td></tr></table></figure>

<p>这里我们直接通过on-remove来捕获子组件抛出的<code>remove</code>事件.</p>
<p>很明显的看到，利用子组件和持续重构可以帮助我们维护越来越复杂的组件关系. </p>
<p><a href="http://codepen.io/leeluolee/pen/dGxCb" target="_blank" rel="external">DEMO6</a></p>
<h2 id="结尾">结尾</h2>
<p>至此，我们在仅40行模板+50行js代码(纯数据的业务操作)实现了一个功能基本完整的组件，并且没有引入任何dom操作.</p>
<p>如果有兴趣，可以查看regularjs的官网 <a href="http://regularjs.github.io/" target="_blank" rel="external">http://regularjs.github.io/</a> 查看更完整的例子。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/tutorial/">tutorial</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/javascript/">javascript</a>, <a href="/tags/regularjs/">regularjs</a>
  </div>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>


</div></div>
    <aside id="sidebar" class="alignright">
<div class="search">
  <form action="http://google.com/search" method="get" accept-charset="utf-8">
    <input type="text" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:leeluolee.github.com">
  </form>
</div>


<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/tutorial/">tutorial</a><small>1</small></li>
  
  </ul>
</div>



<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/npm/">npm</a><small>1</small></li>
  
    <li><a href="/tags/tool/">tool</a><small>3</small></li>
  
    <li><a href="/tags/javascript/">javascript</a><small>6</small></li>
  
    <li><a href="/tags/regularjs/">regularjs</a><small>3</small></li>
  
    <li><a href="/tags/mcss/">mcss</a><small>2</small></li>
  
    <li><a href="/tags/css/">css</a><small>2</small></li>
  
    <li><a href="/tags/3d/">3d</a><small>1</small></li>
  
    <li><a href="/tags/requirejs/">requirejs</a><small>1</small></li>
  
    <li><a href="/tags/nodejs/">nodejs</a><small>1</small></li>
  
  </ul>
</div>




</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 leeluolee
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'leeluolee';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

  <script async src="//codepen.io/assets/embed/ei.js"></script>

</body>
</html>